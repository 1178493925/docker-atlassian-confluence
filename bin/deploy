#!/usr/bin/env bash

# Prepare Git committer information
git config user.email "maage@dotmaage.dk"
git config user.name "Circle CI Automated Builder"

# Obtain the currently latest version of Atlassian Confluence version defined by the
# Dockerfile in this repository.
VERSION=$(sed -nr 's/ENV CONF_VERSION[[:space:]]*(.+)/\1/p' Dockerfile)

echo "Checking for actual changes?"

git diff --exit-code .

if [[ $? == 0 ]]; then

	# The specific branch already exists, consider committing a patch if there
	# was actual changes to the repository.
	echo "There was no changes. Skipping..."

else

	echo "Committing changes"

	git add --all
	git commit --message "Updated Atlassian Confluence EAP branch to version ${VERSION}"

	# Acutally push the new branch to the origin repository (GitHub) such that
	# the changes are published for the Docker Hub repository and everyone else.
	echo "Pushing eap branch"

	git push "origin" "eap" || exit 255

	# Notify the new branch has been deployed.
	echo "Deployed new eap version"

fi
