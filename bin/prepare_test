#!/usr/bin/env bash

echo "Obtaining latest Atlassian Confluence Early Access Preview version information"

# Obtain the latest Atlassian Confluence version by going to the JSON version feed
# information to get a JSONP formatted response, strip the output to retrieve
# the actual content and then get the version number from the first entry.
VERSION=$(curl -Ls 'https://my.atlassian.com/download/feeds/eap/confluence.json' | sed 's/downloads(\(.*\))/\1/g' | jq -r '.[0].version')

echo "Preparing current branch for Atlassian Confluence ${VERSION}"

# Edit the `Dockerfile` by changing the version string to the obtained
# version from the Atlassian Confluence Early Access Preview version feed.
sed --expression "s/\(CONF_VERSION[[:space:]]*\)\([[:digit:]].*\)/\1${VERSION}/g" \
    --expression "s/atlassian-confluence-.*.tar.gz/atlassian-confluence-${VERSION}.tar.gz/g" \
    --in-place Dockerfile
sed --expression "s/^\(> Version \).*$/\1${VERSION}/g" \
    --in-place README.md

echo "Ready for acceptance testing"
